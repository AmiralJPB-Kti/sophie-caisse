-- 1. Création de la liste des invités (Emails autorisés)
CREATE TABLE IF NOT EXISTS sophie_autorisations (
  email TEXT PRIMARY KEY
);

-- Active la sécurité sur cette liste
ALTER TABLE sophie_autorisations ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Lecture pour authentifiés" ON sophie_autorisations FOR SELECT TO authenticated USING (true);

-- 2. Création de la table de caisse
CREATE TABLE IF NOT EXISTS caisse_sophie (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT now(),
  date DATE UNIQUE NOT NULL,
  especes DECIMAL(10,2) DEFAULT 0,
  cb DECIMAL(10,2) DEFAULT 0,
  cheques DECIMAL(10,2) DEFAULT 0,
  depenses DECIMAL(10,2) DEFAULT 0
);
ALTER TABLE caisse_sophie ENABLE ROW LEVEL SECURITY;

-- 3. NETTOYAGE
DROP POLICY IF EXISTS "Acces total public" ON caisse_sophie;
DROP POLICY IF EXISTS "Acces aux utilisateurs connectes uniquement" ON caisse_sophie;
DROP POLICY IF EXISTS "Acces Restreint par Liste" ON caisse_sophie;

-- 4. RÈGLE D'OR : Filtrage par email
CREATE POLICY "Acces Restreint par Liste" 
ON caisse_sophie 
FOR ALL 
TO authenticated 
USING (
  EXISTS (SELECT 1 FROM sophie_autorisations WHERE email = auth.email())
) 
WITH CHECK (
  EXISTS (SELECT 1 FROM sophie_autorisations WHERE email = auth.email())
);
